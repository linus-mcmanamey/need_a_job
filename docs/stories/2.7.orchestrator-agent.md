# Story 2.7: Orchestrator Agent

## Status
✅ **Done**

**Started:** 2025-10-29
**Completed:** 2025-10-29
**Branch:** feature/story-2-7-orchestrator-agent (merged to main)
**PR:** #14

## Story
**As an** Orchestrator Agent,
**I want to** coordinate the entire 7-agent pipeline and make decisions,
**so that** jobs flow through processing stages efficiently with appropriate human approvals.

## Context
Sixth specialized agent in the 7-agent pipeline. The Orchestrator Agent coordinates all previous agents (JobMatcher, SalaryValidator, CVTailor, CoverLetterWriter, QA) and makes decisions about job applications. It implements the "human-in-the-loop" pattern where certain decisions require user approval.

## Dependencies
- ✅ Story 2.1: Agent Base Class
- ✅ Story 2.2: Job Matcher Agent
- ✅ Story 2.3: Salary Validator Agent
- ✅ Story 2.4: CV Tailor Agent
- ✅ Story 2.5: Cover Letter Writer Agent
- ✅ Story 2.6: QA Agent

## Acceptance Criteria

### AC 1: OrchestratorAgent Class Implementation
- [ ] Create `OrchestratorAgent` in `app/agents/orchestrator_agent.py`
- [ ] Inherit from `BaseAgent`
- [ ] Implement `async def process(self, job_id: str) -> AgentResult`
- [ ] Override `agent_name` to return "orchestrator"
- [ ] Override `model` to return "claude-sonnet-4"

### AC 2: Pipeline Coordination
- [ ] Coordinate agent execution sequence:
  1. job_matcher (already completed before orchestrator)
  2. salary_validator (already completed before orchestrator)
  3. cv_tailor (already completed before orchestrator)
  4. cover_letter_writer (already completed before orchestrator)
  5. qa (already completed before orchestrator)
  6. **orchestrator** (current - makes decision)
  7. form_handler (triggered if approved)
- [ ] Check which stages are already completed
- [ ] Verify all required stages completed before making decision

### AC 3: Decision Making Logic
- [ ] Analyze job application data from previous agents
- [ ] Consider factors:
  - Job match score (from job_matcher)
  - Salary validation (from salary_validator)
  - QA pass/fail status (from qa)
  - Job quality indicators
- [ ] Make one of three decisions:
  - **auto_approve**: Automatically approve and proceed to form_handler
  - **needs_human_approval**: Send to user for review
  - **auto_reject**: Reject application (low quality/poor match)

### AC 4: Decision Rules
- [ ] **Auto-Approve** if:
  - job_matcher score >= 85%
  - salary_validator passed
  - qa passed (no critical issues)
  - Job title matches target roles
- [ ] **Needs Human Approval** if:
  - job_matcher score 60-84%
  - OR salary_validator has warnings
  - OR qa passed but has warnings
  - OR job has unique characteristics
- [ ] **Auto-Reject** if:
  - job_matcher score < 60%
  - OR salary_validator failed
  - OR qa failed
  - OR job blacklisted

### AC 5: Claude Decision Support
- [ ] Call Claude Sonnet 4 with decision support prompt
- [ ] Prompt includes:
  - Job details (title, company, description)
  - Match score and reasoning
  - Salary analysis
  - QA results
  - CV/CL summaries
- [ ] Parse Claude response for:
  - Recommended decision (approve/review/reject)
  - Reasoning for recommendation
  - Confidence level
  - Flagged concerns (if any)

### AC 6: Human-in-the-Loop Integration
- [ ] For `needs_human_approval` decision:
  - Update status to "pending_approval"
  - Store decision reasoning
  - Store approval_request with:
    - job_id
    - recommended_action
    - reasoning
    - timestamp
- [ ] Skip form_handler until human approves
- [ ] Log decision for audit trail

### AC 7: Database Updates
- [ ] Update application_tracking:
  - Update `current_stage` to "orchestrator"
  - Append to `completed_stages`
  - Store output in `stage_outputs`:
    ```json
    {
      "orchestrator": {
        "decision": "auto_approve|needs_human_approval|auto_reject",
        "reasoning": "Detailed explanation of decision",
        "confidence": 0.85,
        "flagged_concerns": [],
        "recommended_action": "apply|review|skip",
        "match_score": 87.5,
        "salary_passed": true,
        "qa_passed": true
      }
    }
    ```
  - Update status based on decision:
    - auto_approve: "approved" (ready for form_handler)
    - needs_human_approval: "pending_approval"
    - auto_reject: "rejected"

### AC 8: AgentResult Construction
- [ ] Return `AgentResult` with:
  - `success`: True (orchestrator always succeeds, decision in output)
  - `agent_name`: "orchestrator"
  - `output`: Dictionary with decision, reasoning, scores
  - `error_message`: None or error details
  - `execution_time_ms`: int

### AC 9: Error Handling
- [ ] Handle missing job_id, job data
- [ ] Handle missing previous stage outputs
- [ ] Handle incomplete pipeline (stages not completed)
- [ ] Handle Claude API failures (fallback to rule-based decision)
- [ ] Always return AgentResult

### AC 10: Unit Tests
- [ ] Test file: `tests/unit/agents/test_orchestrator_agent.py`
- [ ] Tests for: structure, decision logic, Claude integration, database updates, error handling
- [ ] Test scenarios:
  - Auto-approve (high match, salary pass, qa pass)
  - Needs approval (medium match)
  - Auto-reject (low match or failed validations)
  - Missing stage outputs
  - Claude API failure fallback
- [ ] Minimum 85% coverage

### AC 11: Integration Tests
- [ ] Deferred to Story 2.8 - not blocking

## Implementation Plan

### Phase 1: Agent Structure (15 min)
1. Create OrchestratorAgent class
2. Implement properties and process() skeleton
3. Basic structure tests

### Phase 2: Stage Verification (25 min)
1. Load and verify previous stage outputs
2. Check all required stages completed
3. Extract key metrics (match_score, salary_passed, qa_passed)
4. Tests for stage verification

### Phase 3: Decision Rules (40 min)
1. Implement decision rule logic
2. Auto-approve criteria
3. Needs-approval criteria
4. Auto-reject criteria
5. Tests for each decision path

### Phase 4: Claude Decision Support (40 min)
1. Build comprehensive decision support prompt
2. Call Claude and parse response
3. Extract recommendation and reasoning
4. Combine Claude + rule-based decisions
5. Tests for Claude integration

### Phase 5: Database & Handoff (30 min)
1. Database updates for each decision
2. Status transitions
3. Approval request creation
4. Tests for database operations

### Phase 6: Error Handling & Testing (30 min)
1. Comprehensive error handling
2. Fallback decision logic
3. Achieve 85%+ coverage

**Total: 3 hours**

## Technical Details

### Decision Flow

```python
def _make_decision(self, job_data, stage_outputs) -> dict:
    """Make orchestration decision."""
    # Extract metrics
    match_score = stage_outputs["job_matcher"]["match_score"]
    salary_passed = stage_outputs["salary_validator"]["passed"]
    qa_passed = stage_outputs["qa"]["pass"]

    # Rule-based decision
    if match_score >= 85 and salary_passed and qa_passed:
        decision = "auto_approve"
    elif match_score < 60 or not salary_passed or not qa_passed:
        decision = "auto_reject"
    else:
        decision = "needs_human_approval"

    # Get Claude recommendation
    claude_rec = await self._get_claude_recommendation(job_data, stage_outputs)

    # Combine decisions
    final_decision = self._combine_decisions(decision, claude_rec)

    return {
        "decision": final_decision,
        "reasoning": "...",
        "confidence": 0.85,
        "match_score": match_score,
        "salary_passed": salary_passed,
        "qa_passed": qa_passed
    }
```

### Claude Decision Prompt

```
You are an Orchestrator Agent making decisions about job applications. Analyze the following job application data and recommend whether to approve, request human review, or reject.

JOB DETAILS:
Title: {job_title}
Company: {company_name}
Location: {location}
Salary: {salary_range}

MATCH ANALYSIS (JobMatcher):
Match Score: {match_score}%
Reasoning: {match_reasoning}

SALARY ANALYSIS (SalaryValidator):
Status: {salary_status}
Analysis: {salary_analysis}

QUALITY ASSURANCE (QA):
Status: {qa_status}
Issues: {qa_issues}

CV/CL SUMMARY:
- CV tailored with {cv_changes} modifications
- CL generated with {cl_highlights} key highlights

DECISION CRITERIA:
- Auto-Approve: Match ≥85%, Salary passed, QA passed
- Human Review: Match 60-84%, OR has warnings
- Auto-Reject: Match <60%, OR validations failed

TASK:
Recommend a decision and provide clear reasoning. Consider:
1. Job quality and fit for candidate
2. Validation results from previous agents
3. Any red flags or concerns
4. Likelihood of success

OUTPUT FORMAT (JSON):
{
  "recommended_decision": "auto_approve|needs_human_approval|auto_reject",
  "reasoning": "Clear explanation of recommendation",
  "confidence": 0.85,
  "flagged_concerns": ["concern 1", "concern 2"]
}
```

### Status Transitions

```
Current Status: "documents_generated" (from QA)
                      ↓
        ┌─────────────┴──────────────┐
        ↓                             ↓
  [Orchestrator Process]      [Error: "pending"]
        ↓
    Decision Made
        ↓
   ┌────┴────┬──────────────┐
   ↓         ↓              ↓
"approved"  "pending_     "rejected"
(auto)      approval"      (auto)
            (human)
```

## Definition of Done
- [x] All ACs met and tested
- [x] Unit tests pass ≥85% coverage (90% achieved)
- [x] Agent registered in AgentRegistry
- [x] Code reviewed and approved (5/5 rating)
- [x] No regressions (170/170 tests passing)
- [x] PR merged to main (#14)
- [x] Retrospective completed

**Story Status:** ✅ Done
**Complexity:** HIGH (coordination + decision logic)
**Expected Duration:** 3 hours
**Actual Duration:** 2.5 hours (17% under estimate)
