# Story 2.6: QA Agent

## Status
In Progress

**Started:** 2025-10-28
**Branch:** feature/story-2-6-qa-agent

## Story
**As a** QA Agent,
**I want to** validate generated CV and CL for quality and accuracy,
**so that** only high-quality applications are submitted.

## Context
Fifth specialized agent in the 7-agent pipeline. Follows Cover Letter Writer Agent and validates the quality of generated CV and Cover Letter documents. Ensures Australian English, formatting consistency, no fabrication, and contact information accuracy.

## Dependencies
- âœ… Story 2.1: Agent Base Class
- âœ… Story 2.4: CV Tailor Agent (validates CV output)
- âœ… Story 2.5: Cover Letter Writer Agent (validates CL output)
- ðŸ“¦ python-docx library (already added)

## Acceptance Criteria

### AC 1: QAAgent Class Implementation
- [ ] Create `QAAgent` in `app/agents/qa_agent.py`
- [ ] Inherit from `BaseAgent`
- [ ] Implement `async def process(self, job_id: str) -> AgentResult`
- [ ] Override `agent_name` to return "qa"
- [ ] Override `model` to return "claude-sonnet-4"

### AC 2: Document Loading
- [ ] Load generated CV file from stage_outputs (cv_tailor.cv_file_path)
- [ ] Load generated CL file from stage_outputs (cover_letter_writer.cl_file_path)
- [ ] Load original CV template from `current_cv_coverletter/Linus_McManamey_CV.docx`
- [ ] Load original CL template from `current_cv_coverletter/Linus_McManamey_CL.docx`
- [ ] Parse DOCX format using python-docx
- [ ] Handle missing files gracefully

### AC 3: Quality Checks
- [ ] **Australian English:** Verify spelling and grammar (e.g., "colour" not "color")
- [ ] **Formatting consistency:** Check fonts, spacing, alignment
- [ ] **No fabrication:** Compare CV/CL content against original templates
- [ ] **Contact information accuracy:** Verify name, email, phone match template

### AC 4: Claude Quality Analysis
- [ ] Call Claude Sonnet 4 with QA analysis prompt
- [ ] Prompt includes:
  - Original CV/CL content (structured)
  - Generated CV/CL content (structured)
  - Quality check instructions
  - Australian English rules
  - Fabrication detection rules
- [ ] Parse Claude response for issues found

### AC 5: Issue Detection and Categorization
- [ ] Detect and categorize issues:
  - **spelling**: Australian vs American spelling
  - **grammar**: Grammar errors
  - **formatting**: Font, spacing, alignment issues
  - **fabrication**: Content not in original template
  - **contact_info**: Name, email, phone mismatch
- [ ] Assign severity levels:
  - **critical**: Must fix before submission
  - **warning**: Should review
  - **info**: Optional improvement

### AC 6: Pass/Fail Decision
- [ ] Approve if no critical issues found
- [ ] Fail if any critical issues found
- [ ] Generate QA report with:
  - Pass/fail status
  - Issues list (type, description, severity)
  - Recommendations (if any)

### AC 7: Database Updates
- [ ] Update application_tracking:
  - Status: "documents_generated" (if approved)
  - Status: "pending" (if critical issues found)
  - Update `current_stage` to "qa"
  - Append to `completed_stages`
  - Store output in `stage_outputs`:
    ```json
    {
      "qa": {
        "pass": true,
        "issues": [
          {
            "type": "spelling",
            "description": "American spelling 'color' should be 'colour'",
            "severity": "critical",
            "location": "CV page 1"
          }
        ],
        "checked_cv": true,
        "checked_cl": true,
        "recommendations": []
      }
    }
    ```

### AC 8: AgentResult Construction
- [ ] Return `AgentResult` with:
  - `success`: True if passed QA
  - `agent_name`: "qa"
  - `output`: Dictionary with pass status, issues, recommendations
  - `error_message`: None or error details
  - `execution_time_ms`: int

### AC 9: Error Handling
- [ ] Handle missing job_id, job data, CV/CL files
- [ ] Handle missing templates
- [ ] Handle Claude API failures
- [ ] Handle file I/O errors
- [ ] Always return AgentResult

### AC 10: Unit Tests
- [ ] Test file: `tests/unit/agents/test_qa_agent.py`
- [ ] Tests for: structure, document loading, quality checks, issue detection, Claude analysis, pass/fail decision, database updates, error handling
- [ ] Minimum 85% coverage

### AC 11: Integration Tests
- [ ] Deferred to Story 2.8 - not blocking

## Implementation Plan

### Phase 1: Agent Structure (15 min)
1. Create QAAgent class
2. Implement properties and process() skeleton
3. Basic structure tests

### Phase 2: Document Loading (25 min)
1. Load CV/CL from stage_outputs
2. Load original templates
3. Parse DOCX content
4. Tests for document loading

### Phase 3: Quality Check Methods (40 min)
1. Implement `_check_australian_english()`
2. Implement `_check_formatting()`
3. Implement `_check_fabrication()`
4. Implement `_check_contact_info()`
5. Tests for each check method

### Phase 4: Claude QA Analysis (40 min)
1. Build comprehensive QA prompt
2. Call Claude and parse response
3. Categorize issues by type and severity
4. Tests for Claude integration

### Phase 5: Pass/Fail Decision (20 min)
1. Implement decision logic (no critical issues = pass)
2. Generate QA report
3. Tests for decision logic

### Phase 6: Database & Testing (20 min)
1. Database updates
2. Comprehensive error handling
3. Achieve 85%+ coverage

**Total: 2.5 hours**

## Technical Details

### Australian English Rules

```python
AUSTRALIAN_VS_AMERICAN = {
    "color": "colour",
    "center": "centre",
    "organization": "organisation",
    "recognize": "recognise",
    "analyze": "analyse",
    "specialized": "specialised",
    "optimized": "optimised",
    # ... more mappings
}
```

### Quality Check Implementation

```python
def _check_australian_english(self, text: str) -> list[Issue]:
    """Check for American vs Australian spelling."""
    issues = []
    for american, australian in AUSTRALIAN_VS_AMERICAN.items():
        if re.search(rf'\b{american}\b', text, re.IGNORECASE):
            issues.append(Issue(
                type="spelling",
                description=f"American spelling '{american}' should be '{australian}'",
                severity="critical",
                location="document"
            ))
    return issues
```

### Claude Prompt Template

```
You are a Quality Assurance Agent for job application documents. Analyze the generated CV and Cover Letter for quality and accuracy.

ORIGINAL CV CONTENT:
{original_cv_content}

GENERATED CV CONTENT:
{generated_cv_content}

ORIGINAL CL CONTENT:
{original_cl_content}

GENERATED CL CONTENT:
{generated_cl_content}

QUALITY CHECKS:
1. **Australian English:** Verify spelling (colour, centre, organisation, recognise, analyse)
2. **Formatting:** Check fonts, spacing, alignment, professional appearance
3. **No Fabrication:** Ensure no skills, experiences, or qualifications added that weren't in original
4. **Contact Information:** Verify name, email, phone, LinkedIn match original exactly

TASK:
Analyze the documents and identify any issues. For each issue, provide:
- Type: spelling | grammar | formatting | fabrication | contact_info
- Description: Clear explanation of the issue
- Severity: critical | warning | info
- Location: Where in the document the issue occurs

RULES:
- Critical issues MUST be flagged (American spelling, fabrication, contact errors)
- Warning issues SHOULD be flagged (minor formatting, grammar)
- Info issues are optional improvements

OUTPUT FORMAT (JSON only):
{
  "issues": [
    {
      "type": "spelling",
      "description": "American spelling 'color' found, should be 'colour'",
      "severity": "critical",
      "location": "CV page 1, paragraph 2"
    }
  ],
  "recommendations": [
    "Consider bolding key achievements for better readability"
  ]
}
```

## Definition of Done
- [ ] All ACs met and tested
- [ ] Unit tests pass â‰¥85% coverage
- [ ] Agent registered in AgentRegistry
- [ ] Code reviewed and approved
- [ ] No regressions

**Story Status:** In Progress
**Complexity:** MEDIUM-HIGH (document comparison + quality analysis)
**Expected Duration:** 2.5 hours
