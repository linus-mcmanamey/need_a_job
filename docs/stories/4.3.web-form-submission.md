# Story 4.3: Simple Web Form Submission

**Epic:** Epic 4 - Application Submission
**Sprint:** Week 4-5
**Story Points:** 13 (High Complexity)
**Estimated Hours:** 4-5
**Dependencies:** Story 4.1 (Application Form Handler Base) ✅

---

## Story Overview

Implement web form submission handler using browser automation (Playwright) to automatically fill and submit simple job application forms on platforms like SEEK and Indeed. This complements the email submission path (Story 4.2) and enables end-to-end automation for web-based applications.

**User Story:**
> **As an** Application Form Handler Agent
> **I want to** automatically fill and submit simple web forms
> **So that** I can apply to jobs on platforms like SEEK and Indeed

---

## Acceptance Criteria

### 1. **Uses Playwright to automate browser (REQ-010)**
   - Launches headless Chrome/Firefox
   - Navigates to application URL
   - Waits for page to load
   - Configurable headless mode (true for production, false for debugging)

### 2. **Detects form fields automatically**
   - Name fields (first name, last name, full name)
   - Email address
   - Phone number
   - Resume/CV upload field
   - Cover letter upload field
   - Optional fields (LinkedIn profile, portfolio URL)
   - Detection via: label text, placeholder text, input name attributes

### 3. **Fills form fields with data**
   - Name: "Linus McManamey" (from config)
   - Email: From config
   - Phone: From config
   - Resume: Upload CV file
   - Cover letter: Upload CL file
   - All data loaded from configuration

### 4. **Handles simple form interactions**
   - Checkboxes (consent, terms & conditions)
   - Radio buttons (employment type, availability)
   - Dropdowns (years of experience, location preferences)
   - Text inputs (basic questions, short answers)

### 5. **Submits form and confirms success**
   - Clicks "Submit" or "Apply" button
   - Waits for confirmation page or success message
   - Takes screenshot of confirmation (save to logs)
   - Validates submission success

### 6. **Tracks submission in database**
   - Updates `application_tracking`:
     - Status: "ready_to_send" → "sending" → "completed"
     - submission_method: "web_form"
     - submitted_timestamp: current UTC time
   - Stores form metadata in stage_outputs:
     - form_url
     - screenshot_path
     - submission_timestamp
     - form_fields_filled

### 7. **Handles form errors gracefully**
   - Missing required fields → mark as "pending" with reason
   - File upload fails → retry once, then mark as "pending"
   - Submit button not clickable → mark as "pending"
   - Timeout (> 120 seconds) → mark as "failed"
   - Navigation errors → mark as "failed"

### 8. **Logs all browser automation steps**
   - Debug logs for page navigation and element detection
   - Info logs for form filling and submission
   - Warning logs for retry attempts
   - Error logs for failures with context
   - Screenshot logs for confirmation pages

---

## Implementation Tasks

### 1. **Create WebFormSubmissionHandler agent class**
   - Inherit from BaseAgent
   - Implement agent_name property: "web_form_submission_handler"
   - Implement process(job_id) method returning AgentResult
   - Initialize Playwright service in __init__

### 2. **Create PlaywrightService class (service layer)**
   - `initialize_browser(headless=True) -> Browser`:
     - Launch Playwright browser
     - Configure browser context
     - Return browser instance
   - `navigate_to_form(browser, url) -> Page`:
     - Navigate to application URL
     - Wait for page load
     - Return page object
   - `detect_form_fields(page) -> dict`:
     - Find name, email, phone fields
     - Find file upload fields (CV, CL)
     - Find submit button
     - Return field mappings
   - `fill_form(page, field_mappings, data) -> bool`:
     - Fill text fields
     - Upload files
     - Handle checkboxes/radio/dropdowns
     - Return success status
   - `submit_form(page, submit_button) -> bool`:
     - Click submit button
     - Wait for navigation/confirmation
     - Return success status
   - `take_screenshot(page, filepath) -> str`:
     - Capture confirmation page
     - Save to specified path
     - Return screenshot path
   - `close_browser(browser) -> None`:
     - Clean up browser resources

### 3. **Implement form field detection strategy**
   - **Name field detection:**
     - Check for labels: "name", "full name", "first name", "last name"
     - Check input attributes: name="name", id="name", placeholder="Your name"
   - **Email field detection:**
     - Check for input type="email"
     - Check for labels: "email", "email address"
   - **Phone field detection:**
     - Check for input type="tel"
     - Check for labels: "phone", "mobile", "contact number"
   - **File upload detection:**
     - Check for input type="file"
     - Check for labels: "resume", "cv", "cover letter"

### 4. **Implement error handling and retries**
   - Page load timeout: 30 seconds
   - Element wait timeout: 10 seconds
   - File upload timeout: 15 seconds
   - Submission timeout: 120 seconds
   - Retry logic: 1 retry for transient failures
   - Screenshot capture on errors

### 5. **Integrate with application tracking**
   - Update status throughout process:
     - "ready_to_send" → "sending" (start)
     - "sending" → "completed" (success)
     - "sending" → "pending" (needs manual intervention)
     - "sending" → "failed" (error)
   - Store submission metadata:
     - form_url
     - screenshot_path
     - fields_filled (list)
     - submission_timestamp

### 6. **Add configuration**
   - Create `config/web_form.yaml`:
     - Browser settings (headless mode, timeout values)
     - Applicant data (name, email, phone)
     - File paths (CV, cover letter)
     - Screenshot directory
     - Field detection patterns (customizable)

### 7. **Add comprehensive logging**
   - Debug: Browser actions, element selectors
   - Info: Form filling progress, submission status
   - Warning: Retry attempts, optional fields skipped
   - Error: Navigation failures, element not found, submission errors

---

## Test Strategy

### Unit Tests
- **PlaywrightService class:**
  - Browser initialization and cleanup
  - Page navigation with mocking
  - Form field detection (various HTML structures)
  - Form filling logic
  - Screenshot capture
  - Error handling (timeouts, element not found)

- **WebFormSubmissionHandler agent:**
  - Agent initialization
  - process() method with mocked PlaywrightService
  - Database update flow
  - Error scenarios (navigation failure, form detection failure)
  - Logging verification

### Integration Tests
- End-to-end form submission (using test forms)
- Database updates after successful submission
- File upload handling (real files)
- Screenshot capture and storage
- Error scenarios with real browser

### Manual Testing
- Test with SEEK application form
- Test with Indeed application form
- Verify screenshot capture
- Check database entries
- Test headless vs non-headless modes

### Test Data
- Sample job data with application URLs
- Test CV/CL files
- Test HTML forms (simple structure)
- Various form layouts for field detection

---

## Technical Design

### Architecture

```
WebFormSubmissionHandler (Agent Layer)
    ↓
PlaywrightService (Service Layer)
    ↓
Playwright Browser Automation
```

### File Structure

```
app/
  agents/
    web_form_submission_handler.py    # Agent implementation
  services/
    playwright_service.py              # Playwright automation service
config/
  web_form.yaml                        # Web form configuration
tests/
  unit/
    agents/
      test_web_form_submission_handler.py
    services/
      test_playwright_service.py
  integration/
    test_web_form_submission_integration.py
```

### Configuration Example

```yaml
# config/web_form.yaml
browser:
  headless: true
  timeout_page_load: 30
  timeout_element_wait: 10
  timeout_file_upload: 15
  timeout_submission: 120

applicant:
  name: "Linus McManamey"
  email: "${EMAIL_USERNAME}"
  phone: "+61 XXX XXX XXX"  # From config
  linkedin_url: "https://linkedin.com/in/linusmcmanamey"

file_paths:
  cv_directory: "export_cv_cover_letter/{job_id}"
  cv_pattern: "CV_*.docx"
  cl_pattern: "CL_*.docx"

screenshots:
  directory: "export_cv_cover_letter/{job_id}"
  filename_pattern: "confirmation_{timestamp}.png"

field_detection:
  name_labels: ["name", "full name", "first name", "last name", "applicant name"]
  email_labels: ["email", "email address", "e-mail"]
  phone_labels: ["phone", "mobile", "contact number", "telephone"]
  cv_labels: ["resume", "cv", "curriculum vitae"]
  cl_labels: ["cover letter", "covering letter", "letter"]
```

### Error Handling Strategy

| Error Type | Status Update | Action |
|---|---|---|
| Page load timeout | `failed` | Log error, capture screenshot |
| Form fields not detected | `pending` | Mark for manual intervention |
| File upload failure | `pending` (after retry) | Retry once, then manual |
| Submit button not found | `pending` | Mark for manual intervention |
| Submission timeout | `failed` | Log error, capture screenshot |
| Navigation error | `failed` | Log error with details |

---

## Dependencies

### Python Packages
- `playwright` - Browser automation (already in requirements.txt if configured)
- `loguru` - Logging (already used)

### External Services
- Playwright browsers (Chromium/Firefox) - need to install with `playwright install`

### Story Dependencies
- ✅ Story 4.1: Application Form Handler Base (provides routing logic)
- ✅ Story 2.4: CV Tailor Agent (provides CV files)
- ✅ Story 2.5: Cover Letter Writer Agent (provides CL files)

---

## Risks and Mitigations

### Risks
1. **Form structure variability:** Different platforms have different HTML structures
   - **Mitigation:** Flexible field detection with multiple patterns

2. **JavaScript-heavy forms:** Forms that require complex interactions
   - **Mitigation:** Mark as "pending" for manual intervention (Story 4.4 will handle complex forms)

3. **Anti-bot detection:** Some platforms may block automated submissions
   - **Mitigation:** Use realistic browser profiles, add random delays between actions

4. **File upload limitations:** Large files may fail to upload
   - **Mitigation:** Pre-check file sizes, compress if needed

5. **Timeout issues:** Slow page loads or form submissions
   - **Mitigation:** Configurable timeouts, retry logic

---

## Success Criteria

**Story is successful when:**
1. Simple web forms can be filled and submitted automatically
2. CV and cover letter files are uploaded correctly
3. Confirmation screenshots are captured and stored
4. Error handling prevents data loss and provides clear failure reasons
5. All tests pass with >85% coverage
6. Manual test confirms successful submission on SEEK/Indeed

---

## Definition of Done

- [ ] Code implemented and follows coding standards
- [ ] Unit tests written and passing (>85% coverage)
- [ ] Integration tests passing
- [ ] Manual testing completed on real forms
- [ ] Code reviewed and approved
- [ ] Documentation updated (this story file, config docs)
- [ ] QA gate passed
- [ ] Merged to main branch

---

## Next Steps After Story 4.3

**Story 4.4:** Complex Form Detection and Handling
- Will detect forms requiring manual intervention (CAPTCHA, multi-step, custom questions)
- Marks complex forms as "pending" instead of attempting submission

**Future Enhancements (V2):**
- ML-based form complexity classification
- Support for multi-step forms
- Intelligent retry strategies
- Form template library for common platforms

---

**Story Planning Complete**
**Status:** Draft
**Created:** 2025-10-29
