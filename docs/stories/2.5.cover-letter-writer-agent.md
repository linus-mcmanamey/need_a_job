# Story 2.5: Cover Letter Writer Agent

## Status
In Progress

**Started:** 2025-10-28
**Branch:** feature/story-2-5-cover-letter-writer

## Story
**As a** Cover Letter Writer Agent,
**I want to** write a personalized cover letter for each job,
**so that** applications demonstrate genuine interest and fit.

## Context
Fourth specialized agent in the 7-agent pipeline. Follows CV Tailor Agent and writes personalized cover letters using Claude Sonnet 4. Extracts contact person name, addresses selection criteria, and maintains professional Australian English tone.

## Dependencies
- âœ… Story 2.1: Agent Base Class
- âœ… Story 2.4: CV Tailor Agent (same output directory pattern)
- ðŸ“¦ python-docx library (already added)

## Acceptance Criteria

### AC 1: CoverLetterWriterAgent Class Implementation
- [ ] Create `CoverLetterWriterAgent` in `app/agents/cover_letter_writer_agent.py`
- [ ] Inherit from `BaseAgent`
- [ ] Implement `async def process(self, job_id: str) -> AgentResult`
- [ ] Override `agent_name` to return "cover_letter_writer"
- [ ] Override `model` to return "claude-sonnet-4"

### AC 2: Template Loading
- [ ] Load CL template from `current_cv_coverletter/Linus_McManamey_CL.docx`
- [ ] Parse DOCX format using python-docx
- [ ] Handle missing template gracefully

### AC 3: Contact Person Extraction
- [ ] Extract contact name from job data fields:
  - `contact_email` (parse name from email)
  - Job description text (look for "Contact", "Hiring Manager", etc.)
- [ ] Default to "Dear Hiring Manager" if not found
- [ ] Use Claude to parse ambiguous contact info

### AC 4: Cover Letter Generation with Claude
- [ ] Call Claude Sonnet 4 with CL generation prompt
- [ ] Prompt includes:
  - Job details (company, title, description)
  - Matched criteria from job_matcher
  - CV highlights
  - Contact person name
  - Instructions for Australian English, professional/friendly tone
- [ ] Generate complete cover letter addressing:
  - Company-specific opening
  - 2-3 relevant achievements
  - Selection criteria from job ad
  - Clear call to action

### AC 5: DOCX Generation
- [ ] Use same output directory as CV (from cv_tailor stage)
- [ ] Save as `Linus_McManamey_CL.docx` in same directory
- [ ] Validate output file (exists, valid DOCX, size < 2MB)

### AC 6: Database Updates
- [ ] Update application_tracking:
  - Set `cl_file_path`
  - Set `contact_person_name`
  - Update `current_stage` to "cover_letter_writer"
  - Append to `completed_stages`
  - Store output in `stage_outputs`:
    ```json
    {
      "cover_letter_writer": {
        "cl_file_path": "path/to/CL.docx",
        "contact_person_name": "Jane Smith",
        "extraction_method": "email|description|default",
        "file_size_bytes": 45678
      }
    }
    ```

### AC 7: AgentResult Construction
- [ ] Return `AgentResult` with:
  - `success`: True if CL generated
  - `agent_name`: "cover_letter_writer"
  - `output`: Dictionary with cl_file_path, contact_person_name, file_size_bytes
  - `error_message`: None or error details
  - `execution_time_ms`: int

### AC 8: Error Handling
- [ ] Handle missing job_id, job data, template
- [ ] Handle Claude API failures
- [ ] Handle file I/O errors
- [ ] Always return AgentResult

### AC 9: Unit Tests
- [ ] Test file: `tests/unit/agents/test_cover_letter_writer_agent.py`
- [ ] Tests for: structure, template loading, contact extraction, Claude generation, DOCX creation, file validation, database updates, error handling
- [ ] Minimum 85% coverage

### AC 10: Integration Tests
- [ ] Deferred to Story 2.8 - not blocking

## Implementation Plan

### Phase 1: Agent Structure (15 min)
1. Create CoverLetterWriterAgent class
2. Implement properties and process() skeleton
3. Basic structure tests

### Phase 2: Template & Contact Extraction (25 min)
1. Template loading method
2. Contact person extraction (email, description, Claude)
3. Tests for extraction logic

### Phase 3: Claude CL Generation (40 min)
1. Build comprehensive prompt
2. Call Claude and parse response
3. Tests for generation

### Phase 4: DOCX Output (20 min)
1. Reuse output directory from cv_tailor
2. Generate CL DOCX
3. Validate file

### Phase 5: Database & Testing (20 min)
1. Database updates
2. Comprehensive error handling
3. Achieve 85%+ coverage

**Total: 2 hours**

## Technical Details

### Contact Person Extraction

```python
def _extract_contact_person(self, job_data: dict) -> tuple[str, str]:
    """
    Extract contact person name from job data.

    Returns:
        Tuple of (name, extraction_method)
    """
    # Try email first
    email = job_data.get("contact_email", "")
    if email:
        name = self._parse_name_from_email(email)
        if name:
            return (name, "email")

    # Try description with Claude
    description = job_data.get("description", "")
    if description:
        name = await self._extract_name_from_description(description)
        if name:
            return (name, "description")

    # Default
    return ("Hiring Manager", "default")
```

### Claude Prompt Template

```
You are a Cover Letter Writer. Write a professional, personalized cover letter for this job application.

JOB DETAILS:
- Company: {company_name}
- Title: {job_title}
- Description: {job_description[:1000]}

MATCHED CRITERIA:
{matched_technologies}

CANDIDATE HIGHLIGHTS:
{cv_highlights}

CONTACT PERSON:
{contact_person_name}

TASK:
Write a complete cover letter that:
1. Opens with company-specific introduction
2. Addresses 2-3 key selection criteria
3. Highlights relevant achievements
4. Shows genuine interest
5. Includes clear call to action
6. Uses professional, friendly tone
7. Australian English spelling/grammar

OUTPUT FORMAT (plain text):
[Full cover letter text]
```

## Definition of Done
- [ ] All ACs met and tested
- [ ] Unit tests pass â‰¥85% coverage
- [ ] Agent registered in AgentRegistry
- [ ] Code reviewed and approved
- [ ] No regressions

**Story Status:** In Progress
**Complexity:** MEDIUM
**Expected Duration:** 2 hours
