# Story 4.2: Email Application Submission

**Epic:** Epic 4 - Application Submission
**Sprint:** Week 4
**Story Points:** 8 (Medium Complexity)
**Estimated Hours:** 2.5-3
**Dependencies:** Story 4.1 (Application Form Handler Base) ✅

---

## Story Overview

Implement email submission handler to automatically send job applications via email with CV and cover letter attachments. This completes the first submission path in the automated job application pipeline.

**User Story:**
> **As an** Application Form Handler Agent
> **I want to** send job applications via email
> **So that** I can submit to email-based job postings

---

## Acceptance Criteria

### 1. **Composes professional application email (REQ-009)**
   - **To:** Company contact email (from job posting detection)
   - **Subject:** "Application for [Job Title] - [Candidate Name]" (or as specified in posting)
   - **Body:** Professional email message with brief introduction
   - **Attachments:** CV and cover letter DOCX files
   - Email body template customizable via config

### 2. **Email configuration from environment/config**
   - SMTP server settings (host, port, use_tls)
   - Sender email account (candidate's email)
   - Authentication credentials (username/password or App Password)
   - Rate limiting settings (max emails per hour)
   - Email size limits

### 3. **Sends email using SMTP protocol**
   - Connects to mail server (SMTP)
   - Authenticates using credentials
   - Sends message with attachments
   - Confirms delivery (checks SMTP response codes)
   - Handles connection errors gracefully

### 4. **Tracks submission in database**
   - Updates `application_tracking`:
     - Status: "ready_to_send" → "sending" → "completed"
     - submission_method: "email"
     - submitted_timestamp: current UTC time
   - Stores email metadata in stage_outputs:
     - recipient_email
     - email_subject
     - email_sent_at
     - smtp_response_code

### 5. **Handles email errors gracefully**
   - Invalid recipient address → mark as "pending" with reason
   - SMTP authentication failure → mark as "failed"
   - Attachment too large → compress or mark as "pending"
   - Network timeout → retry once, then mark as "failed"
   - Missing CV/CL files → mark as "failed"

### 6. **Logs all email sending activity**
   - Debug logs for SMTP connection details
   - Info logs for email composition and sending
   - Warning logs for retry attempts
   - Error logs for failures with context

---

## Implementation Tasks

### 1. **Create EmailSubmissionHandler agent class**
   - Inherit from BaseAgent
   - Implement agent_name property: "email_submission_handler"
   - Implement process(job_id) method returning AgentResult
   - Initialize email service in __init__

### 2. **Create EmailService class (service layer)**
   - `compose_email(job_data, cv_path, cl_path) -> dict`:
     - Build recipient, subject, body
     - Validate email format
     - Check attachment sizes
   - `send_email(email_data) -> dict`:
     - SMTP connection
     - Authentication
     - Message composition with attachments
     - Send and confirm
   - Handle all SMTP exceptions

### 3. **Implement email template system**
   - Default email body template:
     ```
     Dear Hiring Manager,

     I am writing to express my interest in the [Job Title] position at [Company Name].

     Please find attached my CV and cover letter for your consideration.

     I look forward to hearing from you.

     Best regards,
     [Candidate Name]
     ```
   - Support template variables: {job_title}, {company_name}, {candidate_name}
   - Load template from config or use default

### 4. **Add email configuration**
   - Create `config/email.yaml`:
     ```yaml
     smtp:
       host: smtp.gmail.com
       port: 587
       use_tls: true
       username: ${EMAIL_USERNAME}  # From .env
       password: ${EMAIL_PASSWORD}  # App Password from .env
     sender:
       name: "Linus McManamey"
       email: ${EMAIL_USERNAME}
     rate_limiting:
       max_per_hour: 10
       delay_between_emails: 360  # seconds (10 emails/hour)
     attachments:
       max_size_mb: 20
     ```
   - Add .env variables: EMAIL_USERNAME, EMAIL_PASSWORD

### 5. **Implement attachment handling**
   - Locate CV and CL files:
     - Path: `export_cv_cover_letter/{job_id}/`
     - Files: `CV_*.docx`, `CL_*.docx`
   - Validate files exist
   - Check file sizes (< 20 MB combined)
   - Attach to email message

### 6. **Implement error handling and retry logic**
   - SMTP connection timeout: 30 seconds
   - Retry on transient failures:
     - Network timeout → retry once after 60 seconds
     - Temporary SMTP error (4xx codes) → retry once
   - No retry on permanent failures:
     - Invalid recipient (550)
     - Authentication failure (535)
     - Attachment too large
   - Update status appropriately based on error type

### 7. **Implement rate limiting**
   - Track email send timestamps
   - Enforce max 10 emails per hour
   - Delay between emails: 6 minutes (360 seconds)
   - If rate limit reached, mark as "pending" and schedule for later

### 8. **Add comprehensive logging**
   - Debug: SMTP connection details, attachment paths
   - Info: Email composition, recipient, subject, send status
   - Warning: Retry attempts, rate limiting delays
   - Error: SMTP failures, authentication errors, missing files

---

## Test Strategy

### Unit Tests
- **EmailService class:**
  - Email composition (subject, body, template variables)
  - Email format validation (recipient, sender)
  - Attachment handling (file existence, size checks)
  - SMTP connection mocking
  - Error handling (all error types)
  - Retry logic
  - Rate limiting

- **EmailSubmissionHandler agent:**
  - Agent initialization
  - process() method with mocked EmailService
  - Database update flow
  - Error scenarios (missing CV/CL, invalid email)
  - Logging verification

### Integration Tests
- End-to-end email submission (using test SMTP server)
- Database updates after successful send
- File attachment handling (real files)
- Error scenarios with real SMTP (use mailtrap.io or similar)

### Manual Testing (Optional)
- Send real email to personal account
- Verify attachments received correctly
- Check email formatting and content
- Test with Gmail SMTP

### Test Data
- Sample job data with email addresses
- Mock CV/CL files (small test files)
- Test SMTP server configuration (mailtrap.io)
- Invalid email addresses (for error testing)

---

## Technical Notes

### SMTP Library Selection
**Recommendation:** Use `yagmail` library for simplicity:
- Built on top of smtplib
- Easier attachment handling
- Better error messages
- Gmail-optimized

**Alternative:** Use standard `smtplib` + `email` for more control

### Gmail App Password Setup
1. Enable 2FA on Gmail account
2. Generate App Password: Google Account → Security → App Passwords
3. Use App Password in EMAIL_PASSWORD env variable
4. Never use actual Gmail password

### Email Size Limits
- **Gmail:** 25 MB limit
- **Safe target:** < 20 MB (CV + CL combined)
- **Typical sizes:** CV ~200 KB, CL ~150 KB
- **Compression:** Not needed for DOCX files (already compressed)

### Rate Limiting Strategy
- **Gmail free tier:** ~500 emails/day
- **Our limit:** 10 emails/hour (configurable)
- **Delay calculation:** 3600 seconds / 10 emails = 360 seconds (6 minutes)
- **Implementation:** Store last_email_sent timestamp, check before sending

### SMTP Response Codes
- **250:** Success - message accepted
- **421:** Temporary failure - retry later
- **450:** Mailbox unavailable - retry later
- **535:** Authentication failed - don't retry
- **550:** Mailbox not found - don't retry
- **552:** Mailbox full - mark as pending

### Error Classification
**Transient (retry):**
- Network timeout
- SMTP 421 (temporary failure)
- SMTP 450 (mailbox unavailable)

**Permanent (don't retry):**
- Invalid recipient (550)
- Authentication failure (535)
- Attachment too large
- Missing CV/CL files

---

## Dependencies

### External Libraries
- `yagmail` (or `smtplib` + `email.mime`)
- Existing: `python-dotenv` (for .env loading)

### Configuration Files
- `config/email.yaml` (new)
- `.env` (add EMAIL_USERNAME, EMAIL_PASSWORD)

### File Dependencies
- CV files: `export_cv_cover_letter/{job_id}/CV_*.docx`
- CL files: `export_cv_cover_letter/{job_id}/CL_*.docx`

### Database Dependencies
- `application_tracking` table:
  - status field (update to "sending", "completed", "pending", "failed")
  - submitted_timestamp field
  - stage_outputs field (store email metadata)

---

## Complexity Analysis

**Complexity Level:** Medium

**Why Medium?**
- SMTP integration is well-documented
- Email composition is straightforward
- Attachment handling is simple with yagmail
- Error handling requires care but is manageable

**Risks:**
- SMTP authentication issues (mitigated with App Password)
- Network failures (mitigated with retry logic)
- Email deliverability (Gmail may mark as spam if not careful)
- Rate limiting enforcement (need timestamp tracking)

**Mitigations:**
- Use test SMTP server (mailtrap.io) for development
- Comprehensive error handling
- Retry logic for transient failures
- Rate limiting to avoid spam detection
- Logging for debugging

---

## Estimated Effort

- **EmailService implementation:** 1-1.5 hours
- **EmailSubmissionHandler agent:** 0.5 hours
- **Configuration setup:** 0.25 hours
- **Error handling & retry logic:** 0.5 hours
- **Testing (unit + integration):** 0.75-1 hour
- **Total:** 2.5-3 hours

---

## Definition of Done

- [ ] EmailSubmissionHandler agent implemented
- [ ] EmailService class with SMTP integration
- [ ] Email template system implemented
- [ ] Email configuration (email.yaml + .env)
- [ ] Attachment handling (CV + CL files)
- [ ] Error handling and retry logic
- [ ] Rate limiting implemented
- [ ] Comprehensive logging
- [ ] Unit tests written (>90% coverage)
- [ ] Integration tests passing
- [ ] Manual test: send real email successfully
- [ ] Code reviewed and merged
- [ ] Documentation complete

---

## Integration with Story 4.1

**Routing from Story 4.1:**
```python
# In ApplicationFormHandlerAgent
if routing_decision == "email_handler":
    # Trigger Story 4.2: EmailSubmissionHandler
    email_handler = EmailSubmissionHandler(config, claude, app_repo)
    result = await email_handler.process(job_id)
```

**Expected Flow:**
1. Story 4.1 detects email submission method
2. Routes to "email_handler"
3. Story 4.2 (EmailSubmissionHandler) processes job:
   - Composes email
   - Attaches CV/CL
   - Sends via SMTP
   - Updates database
   - Logs activity
4. Job status updated to "completed" or "failed"

---

## Success Criteria

**Story is successful when:**
1. Email submissions work reliably for email-based job postings
2. CV and cover letter attachments are correctly included
3. Error handling prevents data loss and provides clear failure reasons
4. Rate limiting prevents spam detection
5. All tests pass with >90% coverage
6. Manual test confirms real email delivery

---

## Next Steps After Story 4.2

**Story 4.3:** Simple Web Form Submission
- Will handle web form-based submissions
- Uses Playwright for browser automation
- Complements email submission path

**Future Enhancements (V2):**
- Email delivery tracking (read receipts)
- Email template customization per job type
- Alternative email services (SendGrid, AWS SES)
- Batch email sending optimization

---

**Story Planning Complete**
**Status:** Ready for DEV implementation
**Created:** 2025-10-29
