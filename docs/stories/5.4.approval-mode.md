# Story 5.4: Approval Mode

**Epic:** Epic 5 - Gradio UI
**Sprint:** Week 5-6
**Story Points:** 5 (Medium)
**Estimated Hours:** 3-4
**Dependencies:** Story 5.3 (Pending Jobs) ✅, DuckDB schema ✅

---

## Story Overview

Implement approval mode that allows users to review and approve applications before they're sent, providing control over what gets submitted automatically.

**User Story:**
> **As a** user
> **I want to** review and approve applications before they're sent
> **So that** I maintain control over what gets submitted on my behalf

---

## Acceptance Criteria

### 1. **Approval mode toggle (REQ-016)**
   - UI toggle: "Require approval before sending applications"
   - When enabled: Jobs stop at "ready_to_send" status
   - When disabled: Jobs proceed automatically to Application Form Handler
   - Toggle state persists in database (system_config table)
   - Default: Disabled (automatic mode)

### 2. **Pending approvals view (REQ-016)**
   - List all jobs with status="ready_to_send"
   - Show: Job title, company name, platform, match score, created timestamp
   - Sortable by timestamp (oldest first - FIFO)
   - Maximum 20 jobs displayed per view
   - Display CV/CL file paths (for download)

### 3. **Approval actions per job (REQ-016)**
   - **Approve:** Proceed with application
     - Updates status to "approved"
     - Records approval timestamp
     - Note: Queue operations out of scope (no RQ enqueue)
   - **Reject:** Don't apply to this job
     - Updates status to "rejected"
     - Records rejection reason and timestamp
   - Input validation on job_id

### 4. **Approval summary metrics**
   - Count of pending approvals (status="ready_to_send")
   - Oldest pending job (days waiting)
   - Average match score of pending jobs
   - Updates when actions taken

### 5. **Auto-refresh**
   - Metrics refresh every 30 seconds
   - Manual refresh button available

---

## Implementation Tasks

### 1. **Create approval mode service**
   - `app/services/approval_mode.py`
   - Methods:
     - `get_approval_mode_enabled() -> bool`
     - `set_approval_mode(enabled: bool) -> bool`
     - `get_pending_approvals(limit: int = 20) -> list[dict]`
     - `get_approval_summary() -> dict[str, Any]`
     - `approve_job(job_id: str) -> dict[str, Any]`
     - `reject_job(job_id: str, reason: str) -> dict[str, Any]`

### 2. **Update Gradio approval tab**
   - Wire approval mode service to UI components
   - Implement toggle with state persistence
   - Implement action buttons with callbacks
   - Add approval summary metrics
   - Implement auto-refresh with gr.Timer(30)

### 3. **Add tests**
   - Unit tests for approval mode service
   - Mock DuckDB queries
   - Test all action button operations
   - Test toggle state persistence

---

## Technical Design

### Database Queries

```sql
-- Get approval mode setting
SELECT config_value
FROM system_config
WHERE config_key = 'approval_mode_enabled';

-- Set approval mode
INSERT INTO system_config (config_key, config_value, updated_at)
VALUES ('approval_mode_enabled', ?, CURRENT_TIMESTAMP)
ON CONFLICT (config_key) DO UPDATE
    SET config_value = ?, updated_at = CURRENT_TIMESTAMP;

-- Get pending approvals
SELECT
    at.job_id,
    j.job_title,
    j.company_name,
    j.platform_source,
    at.match_score,
    at.cv_path,
    at.cl_path,
    at.created_at,
    at.updated_at
FROM application_tracking at
LEFT JOIN jobs j ON at.job_id = j.job_id
WHERE at.status = 'ready_to_send'
ORDER BY at.created_at ASC
LIMIT ?;

-- Approval summary
SELECT
    COUNT(*) as pending_count,
    AVG(match_score) as avg_match_score,
    MIN(created_at) as oldest_job_date
FROM application_tracking
WHERE status = 'ready_to_send';

-- Approve job
UPDATE application_tracking
SET
    status = 'approved',
    updated_at = CURRENT_TIMESTAMP
WHERE job_id = ?;

-- Reject job
UPDATE application_tracking
SET
    status = 'rejected',
    error_info = json_object('rejection_reason', ?, 'rejection_timestamp', ?, 'manual_action', 'reject'),
    updated_at = CURRENT_TIMESTAMP
WHERE job_id = ?;
```

### System Config Table Schema

```sql
CREATE TABLE IF NOT EXISTS system_config (
    config_key VARCHAR PRIMARY KEY,
    config_value VARCHAR NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Approval Summary Response

```python
{
    "pending_count": int,
    "avg_match_score": float,
    "oldest_job_days": int,  # Days since oldest job created
    "approval_mode_enabled": bool
}
```

### Action Button Returns

```python
{
    "success": bool,
    "message": str,
    "job_id": str
}
```

---

## Success Criteria

- Approval mode toggle persists state correctly
- Pending approvals list displays all ready_to_send jobs
- Approve action updates status to 'approved'
- Reject action updates status to 'rejected' with reason
- Approval summary metrics accurate
- Auto-refresh working (30-second intervals)
- All queries execute in <100ms
- Tests passing (minimum 70% coverage)

---

## Out of Scope

- Bulk approval/rejection (deferred to post-MVP)
- Edit CV/CL before approving (deferred to post-MVP)
- Job detail modal (deferred to post-MVP)
- Auto-reminder notifications (deferred to post-MVP)
- CV/CL preview embedded in UI (download links only)
- Queue operations (no RQ enqueue in MVP)

---

## Technical Risks

### 1. **System Config Table Not Exists**
- **Risk:** system_config table may not exist in database
- **Mitigation:** Create table if not exists in service initialization
- **Fallback:** Default to approval_mode_enabled=false

### 2. **Concurrent Toggle Updates**
- **Risk:** Multiple users could update toggle simultaneously
- **Mitigation:** Use UPSERT with ON CONFLICT for atomic updates
- **Fallback:** Last write wins (acceptable for single-user MVP)

### 3. **Jobs Stuck in ready_to_send**
- **Risk:** With approval mode off, jobs might still be stuck
- **Mitigation:** Document that jobs need approval action or retry
- **Fallback:** Manual status reset in pending jobs page

---

## Definition of Done

- [ ] ApprovalModeService implemented with all 6 methods
- [ ] Unit tests written and passing (minimum 70% coverage)
- [ ] Gradio approval tab integrated with toggle and action buttons
- [ ] Toggle state persists in database
- [ ] Approval actions update database correctly
- [ ] Auto-refresh working
- [ ] Code review completed
- [ ] QA testing completed
- [ ] PR merged to main
- [ ] Retrospective written

---

## QA Results

**Test Execution Date:** 2025-10-30
**QA Reviewer:** Test Architect
**Quality Gate:** PASS ✅

### Test Summary

- **Total Tests:** 20
- **Tests Passed:** 20 (100%)
- **Tests Failed:** 0
- **Code Coverage:** 98% (exceeds 80% requirement by 18%)
- **Test Duration:** 1.53 seconds

### Acceptance Criteria Verification

| Criterion | Status | Evidence |
|-----------|--------|----------|
| AC1: Approval mode toggle | ✅ PASS | UPSERT to system_config verified |
| AC2: Pending approvals list | ✅ PASS | SQL filter and UI integration tested |
| AC3: Approve action | ✅ PASS | Status update to 'approved' verified |
| AC4: Reject action | ✅ PASS | Status update with reason verified |
| AC5: Approval summary | ✅ PASS | All metrics calculated correctly |
| AC6: Auto-refresh (30s) | ✅ PASS | gr.Timer(30) verified |

### Code Quality Metrics

- **Architecture:** EXCELLENT - Clean service abstraction
- **Maintainability:** EXCELLENT - Clear patterns, comprehensive docs
- **Testability:** EXCELLENT - 98% coverage with edge cases
- **Documentation:** EXCELLENT - Complete docstrings
- **Security:** SECURE - Parameterized queries, input validation

### Code Review Grade: A- (Excellent)

- **Security:** A - SQL injection and input validation verified
- **Test Coverage:** A - 98% (best in Epic 5 with Story 5.3)
- **Error Handling:** A - Comprehensive try/except patterns
- **Code Quality:** A- - Minor readability improvements suggested
- **Overall:** APPROVED FOR MERGE

### Comparison to Story 5.3

- Story 5.3: 91% coverage, 20 tests, Grade A
- Story 5.4: 98% coverage, 20 tests, Grade A-
- **Improvement:** +7% coverage, similar quality standards

---

**Status:** Completed ✅
**Created:** 2025-10-30
**Completed:** 2025-10-30
