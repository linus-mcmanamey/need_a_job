# Story 5.3: Pending Jobs Management Page

**Epic:** Epic 5 - Gradio UI
**Sprint:** Week 5-6
**Story Points:** 8 (High)
**Estimated Hours:** 4-6
**Dependencies:** Story 5.2 (Pipeline Page) ✅, DuckDB schema ✅

---

## Story Overview

Implement a pending jobs management page that displays jobs requiring manual intervention, provides error details, and offers action buttons for retry, skip, or manual completion.

**User Story:**
> **As a** user
> **I want to** view and manage jobs that require manual intervention
> **So that** I can complete pending applications and retry failed ones

---

## Acceptance Criteria

### 1. **Pending jobs list displays (REQ-015)**
   - All jobs with status="pending" or status="failed"
   - Show: Job title, company name, platform, error details, timestamp
   - Sortable by timestamp (newest first)
   - Maximum 20 jobs displayed per view

### 2. **Error details shown (REQ-015)**
   - Which agent failed (current_stage field)
   - Error message from error_info JSON
   - Last successful stage
   - Agent outputs from completed stages (if available)

### 3. **Action buttons per job (REQ-015)**
   - **Retry:** Resume from failed agent
     - Clears error_info
     - Updates status to appropriate resume state
     - Note: Queue operations out of scope (no RQ enqueue)
   - **Skip:** Mark as rejected
     - Updates status to "rejected"
     - Records skip reason and timestamp
   - **Manual Complete:** Mark as completed outside system
     - Updates status to "completed"
     - Records manual completion timestamp

### 4. **Error summary visualization**
   - Bar chart showing count by error type
   - Categories: complex_form, api_error, validation_error, timeout, other
   - Updates when filters applied

### 5. **Auto-refresh**
   - Metrics refresh every 30 seconds
   - Manual refresh button available

---

## Implementation Tasks

### 1. **Create pending jobs service**
   - `app/services/pending_jobs.py`
   - Methods:
     - `get_pending_jobs(limit: int = 20) -> list[dict]`
     - `get_error_summary() -> dict[str, int]`
     - `retry_job(job_id: str) -> bool`
     - `skip_job(job_id: str, reason: str) -> bool`
     - `mark_manual_complete(job_id: str) -> bool`
     - `get_job_details(job_id: str) -> dict`

### 2. **Update Gradio pending tab**
   - Wire pending jobs service to UI components
   - Implement action buttons with callbacks
   - Add error summary bar chart
   - Implement auto-refresh with gr.Timer(30)

### 3. **Add tests**
   - Unit tests for pending jobs service
   - Mock DuckDB queries
   - Test all action button operations
   - Test error parsing logic

---

## Technical Design

### Database Queries

```sql
-- Get pending/failed jobs
SELECT
    at.job_id,
    j.job_title,
    j.company_name,
    j.platform_source,
    at.status,
    at.current_stage,
    at.error_info,
    at.updated_at
FROM application_tracking at
LEFT JOIN jobs j ON at.job_id = j.job_id
WHERE at.status IN ('pending', 'failed')
ORDER BY at.updated_at DESC
LIMIT 20;

-- Error summary
SELECT
    json_extract(error_info, '$.error_type') as error_type,
    COUNT(*) as count
FROM application_tracking
WHERE status IN ('pending', 'failed')
    AND error_info IS NOT NULL
GROUP BY error_type
ORDER BY count DESC;

-- Retry job (clear error, reset status)
UPDATE application_tracking
SET
    error_info = NULL,
    status = 'matched',
    updated_at = CURRENT_TIMESTAMP
WHERE job_id = ?;

-- Skip job (mark as rejected)
UPDATE application_tracking
SET
    status = 'rejected',
    error_info = json_object('skip_reason', ?, 'skip_timestamp', ?),
    updated_at = CURRENT_TIMESTAMP
WHERE job_id = ?;

-- Manual complete
UPDATE application_tracking
SET
    status = 'completed',
    error_info = json_object('manual_completion', true, 'timestamp', ?),
    updated_at = CURRENT_TIMESTAMP
WHERE job_id = ?;
```

### Error Info JSON Structure

```python
{
    "error_type": "complex_form" | "api_error" | "validation_error" | "timeout" | "other",
    "error_message": "Human-readable error message",
    "failed_stage": "agent_name",
    "timestamp": "2025-10-29T15:30:00"
}
```

### Action Button Returns

```python
{
    "success": bool,
    "message": str,
    "job_id": str
}
```

---

## Success Criteria

- Pending jobs page displays all failed/pending jobs
- Error details are clear and actionable
- Action buttons work correctly (retry, skip, manual complete)
- Error summary chart updates correctly
- Auto-refresh working (30-second intervals)
- All queries execute in <100ms
- Tests passing (minimum 70% coverage)

---

## Out of Scope

- Bulk actions (deferred to post-MVP)
- Filters and search (deferred to post-MVP)
- Job detail modal (deferred to post-MVP)
- Queue operations (no RQ enqueue in MVP)
- Email notifications for failures
- Pagination (fixed to 20 jobs for MVP)

---

## Technical Risks

### 1. **JSON Error Info Parsing**
- **Risk:** error_info JSON may have inconsistent structure
- **Mitigation:** Defensive JSON parsing with try/except
- **Fallback:** Return "Unknown error" for malformed JSON

### 2. **Database Update Failures**
- **Risk:** Action button operations may fail mid-transaction
- **Mitigation:** Wrap all updates in try/except
- **Fallback:** Return error message to user

### 3. **Stale Data Between Refreshes**
- **Risk:** User takes action on outdated job list
- **Mitigation:** 30-second auto-refresh
- **Fallback:** Job not found errors handled gracefully

---

**Status:** Draft
**Created:** 2025-10-29
