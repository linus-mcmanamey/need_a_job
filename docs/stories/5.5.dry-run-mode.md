# Story 5.5: Dry-Run Mode

**Epic:** Epic 5 - Gradio UI
**Sprint:** Week 5-6
**Story Points:** 3 (Low)
**Estimated Hours:** 2-3
**Dependencies:** Story 5.4 (Approval Mode) ✅, DuckDB schema ✅

---

## Story Overview

Implement dry-run mode that allows users to test the system without sending real applications, providing visibility into CV/CL generation and agent decisions.

**User Story:**
> **As a** user
> **I want to** test the system without sending real applications
> **So that** I can validate CV/CL generation and agent decisions safely

---

## Acceptance Criteria

### 1. **Dry-run mode toggle (REQ-017)**
   - UI toggle: "Dry-run mode (generate but don't send)"
   - When enabled: Pipeline stops before Application Form Handler
   - When disabled: Pipeline runs end-to-end
   - Toggle state persists in database (system_config table)
   - Default: Disabled (normal mode)

### 2. **Dry-run results view (REQ-017)**
   - List all jobs with status="dry_run_complete"
   - Show: Job title, company name, platform, match score, created timestamp
   - Sortable by timestamp (newest first)
   - Maximum 20 jobs displayed per view
   - Display CV/CL file paths (for download)

### 3. **Dry-run to live conversion**
   - **Send Now:** Convert dry-run job to live
     - Updates status from "dry_run_complete" to "ready_to_send"
     - Records conversion timestamp
     - Note: Queue operations out of scope (no RQ enqueue)
   - Input validation on job_id

### 4. **Dry-run analytics**
   - Count of dry-run jobs (status="dry_run_complete")
   - Average match score of dry-run jobs
   - Newest dry-run job (timestamp)
   - Updates when actions taken

### 5. **Auto-refresh**
   - Metrics refresh every 30 seconds
   - Manual refresh button available

---

## Implementation Tasks

### 1. **Create dry-run mode service**
   - `app/services/dry_run_mode.py`
   - Methods:
     - `get_dry_run_mode_enabled() -> bool`
     - `set_dry_run_mode(enabled: bool) -> bool`
     - `get_dry_run_results(limit: int = 20) -> list[dict]`
     - `get_dry_run_analytics() -> dict[str, Any]`
     - `send_now(job_id: str) -> dict[str, Any]`

### 2. **Update Gradio dry-run tab**
   - Wire dry-run mode service to UI components
   - Implement toggle with state persistence
   - Implement "Send Now" button with callback
   - Add dry-run analytics metrics
   - Implement auto-refresh with gr.Timer(30)

### 3. **Add tests**
   - Unit tests for dry-run mode service
   - Mock DuckDB queries
   - Test send_now operation
   - Test toggle state persistence

---

## Technical Design

### Database Queries

```sql
-- Get dry-run mode setting (uses existing system_config table)
SELECT config_value
FROM system_config
WHERE config_key = 'dry_run_mode_enabled';

-- Set dry-run mode
INSERT INTO system_config (config_key, config_value, updated_at)
VALUES ('dry_run_mode_enabled', ?, CURRENT_TIMESTAMP)
ON CONFLICT (config_key) DO UPDATE
    SET config_value = ?, updated_at = CURRENT_TIMESTAMP;

-- Get dry-run results
SELECT
    at.job_id,
    j.job_title,
    j.company_name,
    j.platform_source,
    at.match_score,
    at.cv_file_path,
    at.cl_file_path,
    at.created_at,
    at.updated_at
FROM application_tracking at
LEFT JOIN jobs j ON at.job_id = j.job_id
WHERE at.status = 'dry_run_complete'
ORDER BY at.created_at DESC
LIMIT ?;

-- Dry-run analytics
SELECT
    COUNT(*) as dry_run_count,
    AVG(match_score) as avg_match_score,
    MAX(created_at) as newest_job_date
FROM application_tracking
WHERE status = 'dry_run_complete';

-- Send Now (convert to live)
UPDATE application_tracking
SET
    status = 'ready_to_send',
    updated_at = CURRENT_TIMESTAMP
WHERE job_id = ?
    AND status = 'dry_run_complete';
```

### Dry-Run Analytics Response

```python
{
    "dry_run_count": int,
    "avg_match_score": float,
    "newest_job_hours": int,  # Hours since newest job created
    "dry_run_mode_enabled": bool
}
```

### Action Button Returns

```python
{
    "success": bool,
    "message": str,
    "job_id": str
}
```

---

## Success Criteria

- Dry-run mode toggle persists state correctly
- Dry-run results list displays all dry_run_complete jobs
- Send Now action updates status to 'ready_to_send'
- Dry-run analytics metrics accurate
- Auto-refresh working (30-second intervals)
- All queries execute in <100ms
- Tests passing (minimum 70% coverage)

---

## Out of Scope

- Viewing full agent outputs (deferred to post-MVP)
- Downloading CV/CL files directly from UI (file paths shown only)
- Delete dry-run jobs (deferred to post-MVP)
- Bulk send now (deferred to post-MVP)
- Pipeline behavior changes (agent orchestration out of scope)
- Job detail modal (deferred to post-MVP)

---

## Technical Risks

### 1. **Status Value Not in Schema**
- **Risk:** "dry_run_complete" may not be in application_tracking status CHECK constraint
- **Mitigation:** Verify schema allows this status value
- **Fallback:** Add status via migration if needed

### 2. **Concurrent Send Now Operations**
- **Risk:** Multiple users could send same dry-run job simultaneously
- **Mitigation:** WHERE clause checks status='dry_run_complete' before update
- **Fallback:** Update only if status matches (rowcount check)

### 3. **Dry-Run Jobs Accumulation**
- **Risk:** Dry-run jobs could accumulate and clutter database
- **Mitigation:** Document that dry-run jobs should be reviewed and cleaned
- **Fallback:** Add cleanup feature in post-MVP

---

## Definition of Done

- [x] DryRunModeService implemented with all 5 methods
- [x] Unit tests written and passing (minimum 70% coverage)
- [x] Gradio dry-run tab integrated with toggle and action button
- [x] Toggle state persists in database
- [x] Send Now action updates database correctly
- [x] Auto-refresh working
- [x] Code review completed
- [x] QA testing completed
- [x] PR merged to main
- [x] Retrospective written

---

## QA Results

**Test Execution Date:** 2025-10-30
**QA Reviewer:** Test Architect
**Quality Gate:** PASS ✅

### Test Summary

- **Total Tests:** 17
- **Tests Passed:** 17 (100%)
- **Tests Failed:** 0
- **Code Coverage:** 100% (exceeds 70% requirement by 30%)
- **Test Duration:** 0.63 seconds

### Acceptance Criteria Verification

| Criterion | Status | Evidence |
|-----------|--------|----------|
| AC1: Dry-run mode toggle | ✅ PASS | UPSERT to system_config verified |
| AC2: Dry-run results view | ✅ PASS | SQL filter and UI integration tested |
| AC3: Send Now action | ✅ PASS | Status update to 'ready_to_send' verified |
| AC4: Dry-run analytics | ✅ PASS | All metrics calculated correctly |
| AC5: Auto-refresh (30s) | ✅ PASS | gr.Timer(30) verified |

### Code Quality Metrics

- **Architecture:** EXCELLENT - Clean service abstraction
- **Maintainability:** EXCELLENT - Clear patterns, comprehensive docs
- **Testability:** EXCELLENT - 100% coverage with edge cases
- **Documentation:** EXCELLENT - Complete docstrings
- **Security:** SECURE - Parameterized queries, input validation

### Code Review Grade: A (Excellent)

- **Security:** A (parameterized queries, input validation)
- **Test Coverage:** A+ (100% - best in project!)
- **Error Handling:** A (comprehensive try/except patterns)
- **Code Quality:** A (clean, consistent with Story 5.4)
- **Overall:** APPROVED FOR MERGE

### Comparison to Stories 5.3 and 5.4

- Story 5.3: 91% coverage, 20 tests, Grade A
- Story 5.4: 98% coverage, 20 tests, Grade A-
- Story 5.5: 100% coverage, 17 tests, Grade A
- **Result:** Best coverage in Epic 5!

---

**Status:** Completed ✅
**Created:** 2025-10-30
**Completed:** 2025-10-30
